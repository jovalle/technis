---
# yaml-language-server: $schema=https://taskfile.dev/schema.json

tasks:
  bootstrap:
    cmds:
      - flux check --pre
      - flux bootstrap github --owner=jovalle --repository=technis --branch=main
        --path="./kubernetes/apps" --personal --version={{.FLUX_VERSION}}
      - sops --decrypt
        {{.KUBERNETES_DIR}}/bootstrap/flux/age-key.secret.sops.yaml | kubectl
        --context {{.cluster}} apply --server-side --force-conflicts --filename
        -
    desc: Bootstrap Flux into a Kubernetes cluster
    preconditions:
      - command -v flux
      - command -v sops
      - test -f {{.ROOT_DIR}}/age.agekey
      - test -f {{.KUBERNETES_DIR}}/bootstrap/flux/age-key.secret.sops.yaml
      - sops --decrypt
        {{.KUBERNETES_DIR}}/bootstrap/flux/age-key.secret.sops.yaml
    prompt: Bootstrap Flux into the '{{.cluster}}' cluster ... continue?
    requires:
      vars: ["cluster"]
    summary: |
      Args:
        cluster: Cluster to run command against (required)

vars:
  # renovate: datasource=docker registryUrls=["https://ghcr.io"] depName=ghcr.io/fluxcd/flux-manifests versioning=semver
  FLUX_VERSION: v2.5.1

version: "3"
