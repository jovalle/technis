# kind: PersistentVolumeClaim
# apiVersion: v1
# metadata:
#   name: qbittorrent
#   namespace: watchtower
# spec:
#   storageClassName: longhorn
#   accessModes:
#     - ReadWriteOnce
#   resources:
#     requests:
#       storage: 1Gi
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: qbittorrent-config
  namespace: watchtower
data:
  K8S_CLUSTER: "yes"
  K8S_POD_CIDR: "10.42.0.0/16"
  K8S_SVC_CIDR: "10.43.0.0/16"
  LAN_CIDR: "192.168.0.0/16"
  NAME_SERVERS: "1.1.1.1,8.8.8.8"
  PGID: "1000"
  PUID: "1000"
  UMASK: "002"
  VPN_ENABLED: "yes"
  WEBUI_PORT: "8080"
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: qbittorrent
  namespace: watchtower
  labels:
    app: qbittorrent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: qbittorrent
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: qbittorrent
    spec:
      initContainers:
      #   - name: backup
      #     image: instrumentisto/rsync-ssh
      #     command:
      #       - rsync
      #       - -uva
      #       - /config/
      #       - /config-backup/
      #     volumeMounts:
      #       - name: config
      #         mountPath: /config
      #       - name: config-backup
      #         mountPath: /config-backup
        - name: openvpn-setup
          image: busybox
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - "-c"
            - |
              /bin/sh <<EOF
              wget -qO- https://www.privateinternetaccess.com/openvpn/openvpn.zip | unzip - "us_new_york.ovpn" -d /config/openvpn/
              EOF
          volumeMounts:
            - name: config
              mountPath: /config
      containers:
        - name: qbittorrent
          image: jovalle/qbittorrent-openvpn:v0.3.1
          imagePullPolicy: IfNotPresent
          env:
            - name: VPN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: openvpn
                  key: username
            - name: VPN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: openvpn
                  key: password
          envFrom:
            - configMapRef:
                name: qbittorrent-config
                optional: false
          ports:
            - containerPort: 6881
            - containerPort: 6881
              protocol: UDP
            - containerPort: 8080
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
          volumeMounts:
            - name: config
              mountPath: /config
            - name: downloads
              mountPath: /config/qBittorrent/downloads
            - name: tunnel
              mountPath: /dev/net/tun
            - name: localtime
              mountPath: /etc/localtime
              readOnly: true
          livenessProbe:
            initialDelaySeconds: 60
            periodSeconds: 60
            timeoutSeconds: 5
            exec:
              command:
                - ping
                - "-c 1"
                - "-W 1"
                - 1.1.1.1
          readinessProbe:
            initialDelaySeconds: 60
            periodSeconds: 5
            timeoutSeconds: 5
            tcpSocket:
              port: 8080
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 3Gi
      restartPolicy: Always
      volumes:
        - name: config
        #   persistentVolumeClaim:
        #     claimName: qbittorrent
        # - name: config-backup
          nfs:
            server: illmatic.techn.is
            path: /mnt/hulkpool/technis/qbittorrent
        - name: downloads
          nfs:
            server: illmatic.techn.is
            path: /mnt/hulkpool/downloads
        - name: tunnel
          hostPath:
            path: /dev/net/tun
            type: ""
        - name: localtime
          hostPath:
            path: /etc/localtime
            type: ""
---
kind: Service
apiVersion: v1
metadata:
  name: qbittorrent
  namespace: watchtower
  labels:
    app: qbittorrent
spec:
  selector:
    app: qbittorrent
  type: NodePort
  ports:
    - port: 8080
      protocol: TCP
---
kind: Ingress
apiVersion: networking.k8s.io/v1
metadata:
  name: qbittorrent
  namespace: watchtower
  labels:
    app: qbittorrent
spec:
  rules:
    - host: qbit.technis.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: qbittorrent
                port:
                  number: 8080
    - host: qbittorrent.techn.is
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: qbittorrent
                port:
                  number: 8080