- name: set selinux to permissive
  selinux:
    policy: targeted
    state: permissive
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

- name: disable swap
  block:
    - shell: "swapoff -a"
    - replace:
        dest: /etc/fstab
        regexp: '^(.* swap .*)'
        replace: '#\1'

- name: enable kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  with_items:
  - br_netfilter
  - ip_vs
  - ip_vs_rr
  - ip_vs_sh
  - ip_vs_wrr
  - nf_conntrack

- name: set kernel params
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: yes
  with_items:
  - { name: "net.bridge.bridge-nf-call-iptables", value: '1' }
  - { name: "net.ipv4.ip_forward", value: '1' }
  - { name: "net.netfilter.nf_conntrack_tcp_timeout_close_wait", value: '3600' }
  - { name: "net.netfilter.nf_conntrack_tcp_timeout_established", value: '86400' }

- name: enable ntp
  systemd:
    name: ntp{{ 'd' if (ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux') }}
    state: restarted
    enabled: yes
