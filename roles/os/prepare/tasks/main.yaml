- name: set hostname
  hostname:
    name: "{{ inventory_hostname }}"

- name: update /etc/hostname
  shell: 'echo "{{ inventory_hostname }}" > /etc/hostname '

- name: update /etc/hosts
  lineinfile:
    dest: /etc/hosts
    regexp: "^{{ hostvars[item]['ansible_' + default_interface]['ipv4']['address'] }}.*$"
    line: "{{ hostvars[item]['ansible_' + default_interface]['ipv4']['address'] }} {{ hostvars[item].ansible_fqdn }} {{ item }}"
    state: present
  with_items: "{{ groups['all'] }}"

- name: set selinux to permissive
  selinux:
    policy: targeted
    state: permissive
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

- name: disable swap
  block:
    - shell: "swapoff -a"
    - replace:
        dest: /etc/fstab
        regexp: '^(.* swap .*)'
        replace: '#\1'

- name: enable kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  with_items:
  - br_netfilter
  - ip_vs
  - ip_vs_rr
  - ip_vs_sh
  - ip_vs_wrr
  - nf_conntrack_ipv4

- name: set kernel params
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: yes
  with_items:
  - { name: "net.bridge.bridge-nf-call-iptables", value: '1' }
  - { name: "net.ipv4.ip_forward", value: '1' }
  - { name: "net.netfilter.nf_conntrack_tcp_timeout_close_wait", value: '3600' }
  - { name: "net.netfilter.nf_conntrack_tcp_timeout_established", value: '86400' }

- name: enable ntpd
  systemd:
    name: ntpd
    state: restarted
    enabled: yes
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

- name: enable ntp
  systemd:
    name: ntp
    state: restarted
    enabled: yes
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

- name: create .ssh dir if missing
  file:
    path: /root/.ssh
    mode: 0700
    state: directory

- name: create authorized_keys if missing
  file:
    path: /root/.ssh/authorized_keys
    mode: 0600
    state: touch

- name: render SSH authorized_keys
  lineinfile:
    path: /root/.ssh/authorized_keys
    line: "{{ ssh_public_key }}"

- name: render SSH key
  copy:
    dest: "/root/.ssh/id_rsa"
    content: "{{ ssh_private_key }}"
    mode: 0600

- name: personal touch
  lineinfile:
    path: /root/.bashrc
    line: "{{ item }}"
  with_items:
  - "set -o vi"
  - "export EDITOR=vim"
  - "alias k=kubectl"
