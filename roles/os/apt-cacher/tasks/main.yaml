  - name: install apt-cacher-ng
    block:
    - file:
        name: /etc/apt/apt.conf.d/proxy
        state: absent
      register: demotion
    - import_role: 
        name: os/package/update
      when: demotion.changed
    - package:
        name: apt-cacher-ng
        state: present
    - lineinfile:
        path: /etc/apt-cacher-ng/acng.conf
        line: 'PassThroughPattern: ^(.*):443$'
    - systemd:
        name: apt-cacher-ng
        state: restarted
    delegate_to: "{{ groups['apt_cacher'][0] | default(groups['all'][0]) }}"
    run_once: yes

  - name: configure apt cache clients
    block:

    - name: remove apt-cacher-ng on clients
      apt:
        name: apt-cacher-ng
        state: absent

    - name: ensure config file exists
      file:
        path: /etc/apt/apt.conf.d/proxy
        state: touch

    - name: add apt proxy configuration
      lineinfile:
        path: /etc/apt/apt.conf.d/proxy
        regexp: 'Proxy'
        line: Acquire::http { Proxy "http://{{ groups['apt_cacher'][0] | default(groups['all'][0]) }}.{{ domain }}:3142"; }
        
    when: inventory_hostname != (groups['apt_cacher'][0] | default(groups['all'][0]))
