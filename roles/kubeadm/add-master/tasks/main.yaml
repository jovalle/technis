- name: sync kubernetes certs
  shell: rsync -az -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" {{ groups.masters[0] }}:/etc/kubernetes/pki /etc/kubernetes

- name: render config.yaml
  template:
    src: config.yaml.j2
    dest: "/etc/kubernetes/config.yaml"

- name: enable kubelet service
  systemd:
    name: kubelet
    state: started
    enabled: yes

- name: check kubelet service
  command: systemctl status kubelet
  register: _kubelet
  ignore_errors: true

- name: kubeadm init
  command: kubeadm init --config=/etc/kubernetes/config.yaml
  register: _init
  when: _kubelet.rc > 0

- name: create kubectl config dir
  file:
    path: ~/.kube
    state: directory

- name: copy generated admin.conf
  command: cp /etc/kubernetes/admin.conf ~/.kube/config
