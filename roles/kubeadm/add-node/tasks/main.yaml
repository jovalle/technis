- name: get join command
  command: kubeadm token create --print-join-command
  register: _join
  delegate_to: "{{ groups['masters'][0] }}"

- name: get join token
  debug:
    msg: "{{ _join.stdout }}"

- name: enable kubelet service
  systemd:
    name: kubelet
    state: started
    enabled: yes

- name: check kubelet service
  command: systemctl status kubelet
  register: _kubelet
  delay: 10
  retries: 3
  until: _kubelet.rc > 0
  ignore_errors: true

- name: join node to cluster
  command: "{{ _join.stdout }}"
  when: _kubelet.rc > 0

- name: set worker labels
  block:
  - name: check labels
    command: kubectl get node {{ inventory_hostname}} -o custom-columns=ROLES:.metadata.labels --no-headers
    register: _node
    ignore_errors: yes
  - name: set worker labels
    command: kubectl label node {{ inventory_hostname }} node-role.kubernetes.io/worker=
    when: '"node-role.kubernetes.io/worker" not in _node.stdout'
    ignore_errors: yes
