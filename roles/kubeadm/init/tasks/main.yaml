- name: render config.yaml
  template:
    src: config.yaml.j2
    dest: "/etc/kubernetes/config.yaml"

- name: enable kubelet service
  systemd:
    name: kubelet
    state: started
    enabled: yes

- name: check kubelet service
  command: systemctl status kubelet
  register: _kubelet
  ignore_errors: true

- name: kubeadm init
  command: kubeadm init --config=/etc/kubernetes/config.yaml
  register: _init
  when: _kubelet.rc > 0

- name: create .kube
  file:
    path: ~/.kube
    state: directory

- name: copy admin.conf
  command: cp /etc/kubernetes/admin.conf ~/.kube/config

- name: validate initialization via labels
  block:
  - name: check labels
    command: kubectl get node {{ inventory_hostname}} -o custom-columns=ROLES:.metadata.labels --no-headers
    register: _node
    ignore_errors: yes
  - name: set labels
    command: kubectl label node {{ inventory_hostname }} node-role.kubernetes.io/master=
    when: '"node-role.kubernetes.io/master" not in _node.stdout'
    ignore_errors: yes
