- name: get join command
  command: kubeadm token create --print-join-command
  register: _join
  delegate_to: "{{ groups['captains'][0] }}"

- name: get join token
  debug:
    msg: "{{ _join.stdout }}"

- name: enable kubelet service
  systemd:
    name: kubelet
    state: started
    enabled: yes

- name: check kubelet service
  command: systemctl status kubelet
  register: _kubelet
  delay: 10
  retries: 3
  until: _kubelet.rc > 0
  ignore_errors: true

- name: join worker to cluster
  command: "{{ _join.stdout }}"
  when: _kubelet.rc > 0
