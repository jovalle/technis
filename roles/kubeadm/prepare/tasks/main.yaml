- name: prepare repo for yum
  yum_repository:
    name: kubernetes
    description: Kubernetes Main Repository
    baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
    enabled: yes
    gpgcheck: yes
    repo_gpgcheck: yes
    gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
  when: ansible_distribution == 'CentOS' or ansible_distribution == 'Red Hat Enterprise Linux'

- name: prepare repo for apt
  block:
  - name: onboard kubernetes repo gpg key
    apt_key:
      url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
  - name: add kubernetes repo
    apt_repository:
      repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
  - name: update repos
    apt:
      force_apt_get: yes
      update_cache: yes
      autoremove: yes
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

- name: install core packages for K8s
  include_role:
    name: os/package/install
  vars:
    target_package: "{{ item }}"
  with_items:
  - "{{ k8s_packages }}"

- name: fix IP connectivity in vagrant clusters
  block:
  - name: update kubelet config to include manually defined --node-ip
    lineinfile:
      path: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
      line: Environment="KUBELET_EXTRA_ARGS=--node-ip={{ hostvars[inventory_hostname]['ansible_' + (default_interface | default('eth0'))]['ipv4']['address'] }}"
      insertafter: '^EnvironmentFile'
    register: node_ip_fix
  - name: update and restart kubelet to actuate changes
    systemd:
      name: kubelet
      daemon_reload: yes
      state: restarted
      enabled: yes
    when: node_ip_fix is changed
  when: infrastructure_provisioner == 'vagrant'
