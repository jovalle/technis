- name: deploy cadvisor
  import_role:
    name: kubectl
  vars:
    target_list:
    - cadvisor.yaml
    title: monitoring/cadvisor
    file_type: template

- name: get cadvisor desired count
  shell: kubectl -n monitoring get daemonset cadvisor -o jsonpath="{.status.desiredNumberScheduled}"
  register: desired
  retries: 12
  delay: 10

- name: wait for cadvisor readiness
  shell: kubectl -n monitoring get daemonset cadvisor -o jsonpath="{.status.numberReady}"
  register: ready
  retries: 12
  delay: 10
  until: ready.stdout == desired.stdout

- name: check for prometheus
  shell: kubectl -n monitoring get deployment -l app.kubernetes.io/component=prometheus
  register: prometheus_count

- name: deploy servicemonitor
  import_role:
    name: kubectl
  vars:
    target_list:
    - servicemonitor.yaml
    title: monitoring/cadvisor
    file_type: template