# Fix to Cilium bug in arm64 (https://github.com/cilium/cilium/issues/18131)
- name: disable Strict Reverse Path Forwarding
  sysctl:
    name: "{{ item }}"
    value: "0"
    state: present
    reload: yes
  with_items:
    - net.ipv4.conf.all.rp_filter
    - net.ipv4.conf.default.rp_filter
    - "net.ipv4.conf.{{ default_interface | default('eth0') }}.rp_filter"
  notify: reboot host

#TODO: check that apiserver_endpoint is reachable
#   replace with control_plane[0] IP if not reachable (kube-vip/CNI race condition)

- name: install via helm
  block:
    - name: add cilium repo
      shell: |
        helm repo add cilium https://helm.cilium.io
        helm repo update
    - name: install cilium chart
      shell: >
        helm upgrade --install cilium cilium/cilium --version {{ cilium_version }} \
          --namespace kube-system \
          --set kubeProxyReplacement=strict \
          --set k8sServiceHost="{{ apiserver_endpoint | default('192.168.1.100') }}" \
          --set k8sServicePort=6443 \
          --set ipam.mode="kubernetes" \
          --set operator.replicas={% if groups['cluster'] | length > 3 %}3{% else %}1{% endif %}
  when: disable_kube_proxy | default(False) | bool

- name: check for binary
  stat:
    path: /usr/local/bin/cilium
  register: cilium_binary

- name: check cilium version
  shell: /usr/local/bin/cilium version
  register: cilium_binary_version
  when: cilium_binary.stat.exists

- name: "{% if cilium_binary.stat.exists %}upgrade{% else %}install{% endif %} binary"
  vars:
    arch: "{{ 'arm64' if (ansible_architecture | regex_search('arm|aarch')) else 'amd64' }}"
  block:
    - name: get files
      shell: |
        curl -L --remote-name-all https://github.com/cilium/cilium-cli/releases/{{ cilium_version }}/download/cilium-linux-{{ arch }}.tar.gz{,.sha256sum}
    - name: checksum
      command: sha256sum --check cilium-linux-{{ arch }}.tar.gz.sha256sum
    - name: unarchive tarball
      shell: tar xzvfC cilium-linux-{{ arch }}.tar.gz /usr/local/bin
    - name: remove artifacts
      shell: rm cilium-linux-{{ arch }}.tar.gz{,.sha256sum}
  when: >
    not cilium_binary.stat.exists or
    cilium_version not in cilium_binary_version.stdout

- name: deploy via upstream installer
  block:
    - name: install
      shell: cilium install
    - name: check status
      shell: cilium status
  when: >
      not disable_kube_proxy | default(False) | bool and
      not cilium_helm_install | default(False) | bool

- name: check healthy status
  shell: cilium status
  register: cilium_status
  retries: 20
  delay: 3
  until: cilium_status.rc == 0

- name: run network tests
  block:
    - name: start connectivity tests
      shell: cilium connectivity test
  always:
    - name: cleanup tests
      shell: kubectl delete ns cilium-test --ignore-not-found
  when: cilium_tests | default(False) | bool