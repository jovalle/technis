- name: update kube-api route to LB endpoint
  import_role:
    name: kubectl
  vars:
    source_role: calico
    file_type: template
    target_list:
      - k8s-svc-endpoints.yaml
  when:
    - control_plane_fqdn is defined
    - control_plane_port is defined

- name: deploy calico
  import_role:
    name: kubectl
  vars:
    source_role: calico
    file_type: template
    target_list:
      - calico.yaml

- name: disable kube-proxy (replaced by Calico eBPF DP)
  shell: |
    kubectl patch ds -n kube-system kube-proxy -p '{"spec":{"template":{"spec":{"nodeSelector":{"non-calico": "true"}}}}}'
  ignore_errors: yes
  when: calico_ebpf

- name: get node count
  command: kubectl get nodes --no-headers
  register: node_count

- name: wait until calico-node is ready
  command: kubectl -n kube-system get ds calico-node -o jsonpath='{.status.numberReady}'
  register: number_ready
  retries: 10
  delay: 30
  until: number_ready.stdout == (node_count.stdout_lines | length | string)