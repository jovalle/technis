- name: deploy tigera operator
  import_role:
    name: kubectl
  vars:
    target_list:
    - https://docs.projectcalico.org/manifests/tigera-operator.yaml
    source_role: cni/calico/deploy
    file_type: remote

- name: wait for tigera-operator readiness
  shell: kubectl -n tigera-operator get deployment tigera-operator -o jsonpath="{.status.readyReplicas}"
  register: ready
  retries: 6
  delay: 10
  until: ready.stdout == '1'

- name: deploy custom installation
  import_role:
    name: kubectl
  vars:
    target_list:
    - custom-resources.yaml
    source_role: cni/calico/deploy
    file_type: template

- name: wait for calico-node readiness
  shell: kubectl -n calico-system get ds calico-node -o jsonpath="{.status.numberReady}"
  register: ready
  retries: "{{ 6 * (groups['cluster'] | length) }}"
  delay: 10
  until: ready.stdout == '6'
