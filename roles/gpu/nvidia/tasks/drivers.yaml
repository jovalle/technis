- name: install headless drivers
  apt:
    name: "{{ item }}"
    state: present
  with_items:
    - ubuntu-drivers-common
    - nvidia-headless-510
    - nvidia-utils-510
    - libnvidia-encode-510
  notify: reboot host

- name: flush handler calls for immediate effect
  meta: flush_handlers

- name: add apt signing key for nvidia-docker
  apt_key:
    url: https://nvidia.github.io/nvidia-docker/gpgkey

# Hard coded contents of https://nvidia.github.io/nvidia-docker/ubuntu18.04/nvidia-docker.list
# due to no support for 302 redirections from ubuntu20.04 to ubuntu 18.04 and repo param does
# not download file.
- name: add apt repository for nvidia-docker
  apt_repository:
    repo: "{{ item }}"
    filename: nvidia-docker
  with_items:
    - deb https://nvidia.github.io/libnvidia-container/stable/ubuntu18.04/$(ARCH) /
    - deb https://nvidia.github.io/nvidia-container-runtime/stable/ubuntu18.04/$(ARCH) /
    - deb https://nvidia.github.io/nvidia-docker/ubuntu18.04/$(ARCH) /

- name: install nvidia runtime
  apt:
    name: nvidia-container-runtime
    update_cache: yes