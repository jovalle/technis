- name: check cfssl
  command: command -v cfssl
  ignore_errors: yes
  no_log: yes
  register: bin

- name: install cfssl
  get_url:
    url: "https://pkg.cfssl.org/R1.2/{{ item }}_linux-{{ 'arm' if (ansible_architecture | regex_search('arm|aarch')) else 'amd64' }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: 0755
  with_items:
  - cfssl
  - cfssljson
  when: bin.rc != 0

- name: ensure target_dir exists
  file:
    path: "{{ target_dir }}"
    state: directory

- name: check for root CA certificate
  stat:
    path: "{{ target_dir }}/ca.pem"
  register: root_ca

- name: render root CA from vault
  copy:
    content: "{{ item.content }}"
    dest: "{{ item.dest }}"
  with_items:
  - { content: "{{ cert_ca_crt }}", dest: "{{ target_dir }}/ca.pem" }
  - { content: "{{ cert_ca_key }}", dest: "{{ target_dir }}/ca-key.pem" }
  when: cert_ca_crt is defined and root_ca.stat.exists == False
  no_log: yes