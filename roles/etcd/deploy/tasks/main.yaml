- name: create tmpdir
  tempfile:
    state: directory
  register: tempdir

- name: check binaries
  stat:
    path: /usr/local/bin/etcd
  register: bin

- name: install etcd binaries
  block:
  - name: download binaries from src
    unarchive:
      src: "https://storage.googleapis.com/etcd/v3.3.18/etcd-v3.3.18-linux-amd64.tar.gz"
      dest: "{{ tempdir.path }}"
      remote_src: yes
      mode: 0755
      owner: root
      group: root
  - name: mv binaries to /usr/local/bin
    command: "mv {{ tempdir.path }}/etcd-v3.3.18-linux-amd64/{{ item }} /usr/local/bin/"
    with_items:
    - etcd
    - etcdctl
  always:
  - name: clean up tempdir
    file:
      path: "{{ tempdir.path }}"
      state: absent
  when: bin.stat.exists == False

- name: create etcd dirs
  file:
    path: "{{ item }}"
    state: directory
  with_items:
  - /etc/etcd/pki
  - /var/lib/etcd

- name: render systemd unit
  template:
    src: etcd.service.j2
    dest: /etc/systemd/system/etcd.service
  register: systemd

- name: (re)start systemd unit
  systemd:
    name: etcd
    state: restarted
    enabled: yes
    daemon_reload: yes
  when: systemd.changed