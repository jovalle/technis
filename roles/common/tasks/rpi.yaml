- name: check for dphys-swapfile
  stat:
    path: /etc/dphys-swapfile
  register: dphys_swapfile

- name: disable swap in /etc/dphys-swapfile
  block:
    - name: nullify swap size config
      replace:
        dest: /etc/dphys-swapfile
        regexp: '^.*(CONF_SWAPSIZE.*)$'
        replace: 'CONF_SWAPSIZE=0'

    - name: turn off swap via cli
      command: dphys-swapfile swapoff

    - name: disable dphys-swapfile service
      systemd:
        name: dphys-swapfile
        state: stopped
        enabled: no
        masked: yes
      # if masked, will cause failures
      ignore_errors: yes

    - name: delete swap file
      file:
        path: /var/swap
        state: absent
  when:
    - dphys_swapfile.stat.exists

- name: disable pi user password
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#PasswordAuthentication.*"
    line: "PasswordAuthentication no"
  notify: restart ssh

- name: update keyboard layout
  replace:
    path: /etc/default/keyboard
    regexp: "^XKBLAYOUT=.*$"
    replace: 'XKBLAYOUT="us"'
  notify: reboot host

- name: update locale
  block:
    - name: enable locale
      lineinfile:
        path: /etc/locale.gen
        regexp: '^# en_US.UTF-8 UTF-8'
        line: "en_US.UTF-8 UTF-8"

    - name: generate locale
      command: locale-gen

    - name: save locale
      copy:
        content: |
          # Ansible managed
          LANG="{{ common_locale }}"
          LANGUAGE="{{ common_locale }}"
          LC_ALL="{{ common_locale }}"
        dest: /etc/default/locale

# Fixes known issue with ubuntu server 21.10
# Source: https://github.com/k3s-io/k3s/issues/4188#issuecomment-982503626
- name: install vxlan modules for k3s
  apt:
    name: linux-modules-extra-raspi
  notify: reboot host