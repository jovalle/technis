---

- hosts: control_plane
  become: yes
  pre_tasks:
  - name: gather facts for all hosts
    setup:
    delegate_to: "{{ item }}"
    delegate_facts: yes
    with_items: "{{ groups['all'] }}"
  roles:
  - name: keepalived
    when:
    - (groups['control_plane'] | length) > 1
    - keepalived | default("no") | bool
  - name: haproxy
    when: keepalived | default("no") | bool

- hosts: cluster
  become: yes
  roles:
  - k8s
  - k8s/cluster
  - k8s/labels

- hosts: control_plane
  become: yes
  run_once: yes
  tasks:
  - name: allow scheduling to control plane
    command: kubectl taint nodes --all node-role.kubernetes.io/master-
    ignore_errors: yes
    when: control_plane_schedulable | default("no") | bool

- hosts: control_plane[0]
  vars:
    cluster_node_count: "{{ groups['cluster'] | length }}"
    control_plane_node_count: "{{ groups['control_plane'] | length }}"
  roles:
  - name: cni
    tags:
    - cni
  - name: storage
    tags:
    - storage
  - name: loadbalancer
    tags:
    - loadbalancer
  - name: cert-manager
    tags:
    - cert-manager
  - name: ingress
    tags:
    - ingress
#  - name: monitoring
