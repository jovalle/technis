- hosts: all
  gather_facts: no
  ignore_unreachable: yes
  tasks:
    - name: set authorized_key for root user
      authorized_key:
        user: root
        state: present
        key: "{{ ssh_public_key }}"
      ignore_errors: yes
    - name: check if pi user exist
      command: id -un pi
      register: pi_user
      ignore_errors: yes
    - name: kill all running pi user processes
      command: pkill -u pi
      ignore_errors: yes
      when: pi_user.rc == 0
    - name: disable pi user
      user:
        name: pi
        password: '!'
      when: pi_user.rc == 0

- hosts: all
  pre_tasks:
    - name: gather facts from ALL hosts (regardless of limit or tags)
      setup:
      delegate_to: "{{ item }}"
      delegate_facts: True
      when: hostvars[item]['ansible_default_ipv4'] is not defined
      with_items: "{{ groups['all'] }}"
  roles:
    - common