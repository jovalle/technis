- hosts: cluster
  roles:
    - name: k3s/reset
      when:
        - reset is defined
        - reset | default('no') | bool
    - name: common
      tags:
        - common
    - name: cri
      tags:
        - cri
    - name: helm
      tags:
        - helm
    - name: k3s
      tags:
        - k3s

- hosts: control_plane
  run_once: yes
  roles:
    - name: cni
      tags:
        - cni
    - name: cert-manager
      tags:
        - cert-manager
    - name: storage
      tags:
        - storage
    - name: monitoring
      tags:
        - monitoring

- import_playbook: telegraf.yaml
  tags:
    - monitoring
    - telegraf

- hosts: localhost
  roles:
    - name: kubectl/context
      tags:
        - kubeconfig
  tasks:
    - name: deploy private manifests
      block:
        - name: check for technis-private
          stat:
            path: "{{ playbook_dir }}/../../technis-private"
          register: technis_private
        - name: apply manifests from technis-private
          shell: kubectl apply -f {{ technis_private.stat.path }}
          when: technis_private.stat.exists | default('no') | bool
      tags:
        - private
    - name: deploy addon manifests
      shell: kubectl apply -f {{ playbook_dir }}/../files/{{ item }}
      with_items:
        - "{{ addon_manifests }}"
      tags:
        - addons