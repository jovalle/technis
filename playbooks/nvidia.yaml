- hosts: all
  pre_tasks:
  - name: check host has an nvidia card
    shell: >
      lspci | grep -i nvidia | wc -l
    register: nvidia_check
    failed_when: nvidia_check.stdout == '0'
  tasks:
  - name: check driver version
    shell: >
      nvidia-smi | grep 'NVIDIA-SMI' | awk '{print $3}'
    register: nvidia_driver_version
    ignore_errors: yes
  - name: install nvidia drivers
    block:
    - tempfile:
        state: directory
      register: tempdir
    - file:
        path: /etc/modprobe.d/nvidia-installer-disable-nouveau.conf
        state: file
    - lineinfile:
        path: /etc/modprobe.d/nvidia-installer-disable-nouveau.conf
        line: '{{ item }}'
      loop:
      - blacklist nouveau
      - options nouveau modeset=0
      register: modprobe_disable_nouvaeu
    - reboot:
      when: modprobe_disable_nouvaeu.changed
    - get_url:
        url: https://international.download.nvidia.com/XFree86/Linux-x86_64/455.45.01/NVIDIA-Linux-x86_64-455.45.01.run
        dest: '{{ tempdir.path }}'
        mode: '0755'
    - shell: '{{ tempdir.path }}/NVIDIA-Linux-x86_64-455.45.01.run -A -q -s --dkms'
    - shell: nvidia-smi
    always:
    - file:
        path: '{{ tempdir.path }}'
        state: absent
    when: nvidia_driver_version is not defined or nvidia_driver_version.stdout != '455.45.01'
  - name: patch nvidia transcoder
    block:
    - tempfile:
        state: directory
      register: tempdir
    - git:
        repo: https://github.com/keylase/nvidia-patch
        dest: '{{ tempdir.path }}'
    - shell: '{{ tempdir.path }}/patch.sh'
    always:
    - file:
        path: '{{ tempdir.path }}'
        state: absent
  - name: check for nvidia-container-runtime bin
    stat:
      path: /usr/bin/nvidia-container-runtime
    register: nvidia_container_runtime
  - name: install nvidia runtime for docker
    block:
    - name: add nvidia-docker official GPG key
      shell: >
        distribution=$(. /etc/os-release;echo $ID$VERSION_ID) 
        && curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
        && curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
      args:
        warn: no
    - name: update repos and install nvidia-docker2
      apt:
        force_apt_get: yes
        update_cache: yes
        autoremove: yes
        name: ['nvidia-docker2']
        state: present
    - name: restart docker
      systemd:
        name: docker
        state: restarted
    when: nvidia_container_runtime.stat.exists == False
  - name: check for nvtop bin
    stat:
      path: /usr/local/bin/nvtop
    register: nvtop
  - name: install nvtop
    block:
    - apt:
        name: ['cmake', 'libncurses5-dev', 'libncursesw5-dev', 'git']
    - tempfile:
        state: directory
      register: tempdir
    - git:
        repo: https://github.com/Syllo/nvtop
        dest: '{{ tempdir.path }}'
    - file:
        path: '{{ tempdir.path }}/build'
        state: directory
    - shell: chdir='{{ tempdir.path }}/build' cmake .. -DNVML_RETRIEVE_HEADER_ONLINE=True
    - shell: chdir='{{ tempdir.path }}/build' make
    - shell: chdir='{{ tempdir.path }}/build' make install
    always:
    - file:
        path: '{{ tempdir.path }}'
        state: absent
    when: nvtop.stat.exists == False
