- hosts: nexus
  tags:
    - always
  pre_tasks:
    - name: apt updrade
      apt:
        upgrade: full
        update_cache: yes
        cache_valid_time: 3600
        force_apt_get: true
        autoclean: yes
        autoremove: yes
  roles:
    - common

- hosts: nexus
  vars:
    target_interface: enp3s0
  tags:
    - network
  tasks:
    - name: check for {{ target_interface }}
      shell: ifconfig {{ target_interface }}
      ignore_errors: yes
      register: ifconfig
    - name: rename {{ target_interface }} to eth0 using netplan
      block:
        - set_fact:
            mac_addr: "{{ hostvars[inventory_hostname]['ansible_' + target_interface]['macaddress'] }}"
        - debug: var=mac_addr
        - copy:
            content: |
              # Ansible managed
              network:
                ethernets:
                  eth0:
                    dhcp4: true
                    match:
                      macaddress: {{ mac_addr }}
                    optional: true
                    set-name: eth0
                version: 2
            dest: /etc/netplan/00-technis.yaml
        - command: netplan apply
      when:
        - ifconfig.rc | int == 0
        - ansible_distribution == "Ubuntu"

- hosts: nexus
  tags:
    - zfs
  tasks:
    - name: install zfs
      package:
        name: "{{ item }}"
      with_items:
        - zfsutils-linux
    - name: import all available zpools
      command:
        cmd: zpool import -a -f
        creates: /hulkpool

- hosts: nexus
  tags:
    - services
  roles:
    - fail2ban

- import_playbook: nfs.yaml
  tags:
    - services
    - nfs

- import_playbook: smb.yaml
  tags:
    - services
    - smb

- import_playbook: gpu.yaml
  tags:
    - gpu