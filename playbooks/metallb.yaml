- hosts: control_plane
  run_once: yes
  tasks:
    - name: deploy metallb namespace
      shell: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml
    - name: apply metallb configuration
      shell: |
        cat << EOF | kubectl apply -f -
        kind: ConfigMap
        apiVersion: v1
        metadata:
          name: config
          namespace: metallb-system
        data:
          config: |
            peers:
            - peer-address: 192.168.1.1
              peer-asn: 64501
              my-asn: 64500
            address-pools:
            - name: default
              protocol: bgp
              avoid-buggy-ips: true
              addresses:
              - 192.168.10.0/24
        EOF
    - name: deploy metallb
      shell: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml