- hosts: all
  gather_facts: yes
  become: yes
  tasks:
  - name: setup nfs server
    block:
    - package:
        name: nfs-kernel-server
        state: present
    - lineinfile:
        path: /etc/exports
        regex: ^/var/lib/media
        line: /var/lib/media *(rw,sync,no_subtree_check,no_root_squash)
    - command: exportfs
    - systemd:
        name: nfs-kernel-server
        state: restarted
    delegate_to: "{{ nfs_server }}"
  - name: setup nfs clients
    block:
    - package:
        name: nfs-common
        state: present
    - file:
        path: /var/lib/media
        state: directory
    - lineinfile:
        path: /etc/fstab
        regex: "^{{ nfs_server }}:/var/lib/media"
        line: "{{ nfs_server }}:/var/lib/media /var/lib/media nfs4 vers=4.1,rsize=1048576,wsize=1048576,namlen=255,hard,timeo=600,retrans=2,sec=sys 0 0"
    - command: mount /var/lib/media
    delegate_to: "{{ nfs_clients }}"
