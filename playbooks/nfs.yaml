- hosts: all
  tasks:
  - name: setup nfs server
    block:
    - package:
        name: nfs-kernel-server
        state: present
    - lineinfile:
        path: /etc/exports
        regex: ^/hulkpool
        line: /hulkpool *(rw,sync,no_subtree_check,no_root_squash)
    - command: exportfs
    - systemd:
        name: nfs-kernel-server
        state: restarted
    delegate_to: "{{ nfs_server }}"
  - name: setup nfs clients
    block:
    - package:
        name: nfs-common
        state: present
    - file:
        path: /hulkpool
        state: directory
    - lineinfile:
        path: /etc/fstab
        regex: "^{{ nfs_server }}:/hulkpool"
        line: "{{ nfs_server }}:/hulkpool /hulkpool nfs4 vers=4.1,rsize=1048576,wsize=1048576,namlen=255,hard,timeo=600,retrans=2,sec=sys 0 0"
    - command: mount /hulkpool
    delegate_to: "{{ nfs_clients }}"
