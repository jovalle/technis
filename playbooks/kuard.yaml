- hosts: controllers[0]
  become: yes
  gather_facts: yes
  tasks:
  - block:

    - name: apply deployment
      import_role:
        name: kubectl
      vars:
        command: apply
        source_role: kuard
        file_type: template
        target_list:
        - kuard.yaml

    - name: validate ingress
      uri:
        url: https://kuard.{{ domain_apps }}
        status_code: 200
      register: curl_validation
      until: curl_validation.status == 200
      retries: 6
      delay: 10

    always:
    - name: delete deployment
      import_role:
        name: kubectl
      vars:
        command: delete
        source_role: kuard
        file_type: template
        target_list:
        - kuard.yaml
      ignore_errors: yes
