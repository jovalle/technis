- name: configure local kubeconfig
  hosts: localhost
  tasks:
    - name: ensure kube dir exists
      file:
        path: ~/.kube/
        state: directory
    - name: get admin kubeconfig
      fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: ~/.kube/config
        flat: yes
      delegate_to: "{{ groups['control_plane'][0] }}"
    - name: replace 127.0.0.1 in local kubeconfig
      replace:
        path: ~/.kube/config
        regexp: '127\.0\.0\.1'
        replace: '{{ apiserver_endpoint | default("192.168.1.100") }}'
        mode: 0600
    - name: get cluster-info with local kubeconfig
      command: kubectl cluster-info