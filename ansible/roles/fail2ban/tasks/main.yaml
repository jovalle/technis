---
- name: Ensure fail2ban is installed
  ansible.builtin.apt:
    name: fail2ban
    state: present

- name: Configure fail2ban for SSH
  ansible.builtin.copy:
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 3

      [sshd]
      enabled = true
      port = {{ ssh_port }}
      logpath = /var/log/auth.log
      ignoreip = 127.0.0.1/8 {{ lan_network }}
    dest: /etc/fail2ban/jail.local
    mode: "0644"
  notify: restart fail2ban

- name: Ensure fail2ban is enabled and started
  ansible.builtin.service:
    name: fail2ban
    enabled: true
    state: started
